#!/bin/bash
source f5-onboard-utils

if [ $# -lt 3 ]; then
    echo "usage: f5-onboard-set-state <collection> <entity> <variable-name>=<value>"
    echo "variables are name-value pairs that belong to an entity"
    echo "that is part of a collection"
    echo "Examples:"
    echo "$ f5-onboard-set-state deployments odk-maas CLUSTER_NAME=admin1"
    echo "$ f5-onboard-set-state clusters admin1 MGMT_IPS=10.1.1.1,10.1.1.2"
    exit 1
fi

# 
# Name value pairs (NAME=VALUE) are stored in a file with this name:
# $F5_ONBOARD_STATE_DIR/$COLLECTION/$ENTITY
# 

COLLECTION=$1
ENTITY=$2
NAME_VALUE=$3

VARIABLE_NAME=`echo $NAME_VALUE | cut -d= -f1`
VARIABLE_VALUE=`echo $NAME_VALUE | cut -d= -f2-`
ENTITY_DATAFILE="$F5_ONBOARD_STATE_DIR/$COLLECTION/$ENTITY"

mkdir -p $F5_ONBOARD_STATE_DIR/$COLLECTION
touch $ENTITY_DATAFILE
set +e
grep -q -e "^$VARIABLE_NAME=" $ENTITY_DATAFILE
retval=$?
set -e
if [ $retval = 0 ]; then
    sed -i "s/^$VARIABLE_NAME=.*/$VARIABLE_NAME=$VARIABLE_VALUE/" $ENTITY_DATAFILE
else
    echo "$VARIABLE_NAME=$VARIABLE_VALUE" >> $ENTITY_DATAFILE
fi
