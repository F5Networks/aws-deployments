#!/bin/bash
source f5-onboard-utils

function show_usage {
    echo "Usage: "
    echo "f5-onboard-cluster-bigips \\"
    echo "    --keystone-addr <addr> \\"
    echo "    --admin-password <pw> \\"
    echo "    --bigip-image <img> \\"
    echo "    --ha-type scalen pair standalone \\"
    echo "    --num-bigips <num> \\"
    echo "    --bigip-floating-ip-addr-list <list> \\"
    echo "    --bigip-mgmt-addr-list <list> \\"
    echo "         # List of bigip management addresses. \\"
    echo "    --bigip-ha-addr-list', <list> \\"
    echo "         # List of bigip HA addresses. \\"
    echo "    --bigip-mirror-addr-list', <list> \\"
    echo "         # List of bigip mirroring addresses."

}

# Parse command line switches
while [ $# -gt 0 ]; do
   case "$1" in
       --keystone-addr)  KEYSTONE=$2 ; shift 2 ;;
       --admin-password) ADMIN_PASSWORD=$2 ; shift 2 ;;
       --ha-type)        HA_TYPE=$2 ; shift 2 ;;
       --bigip-image)    BIGIP_IMAGE=$2 ; shift 2 ;;
       --num-bigips)     NUM_BIGIPS=$2 ; shift 2 ;;
       *)    show_usage; exit 1;;
   esac
done


if [ "$HA_TYPE" == "standalone" ]; then
    NUM_BIGIPS=1
elif [ "$HA_TYPE" == "pair" ]; then
    NUM_BIGIPS=2
elif [ "$HA_TYPE" == "scalen" ]; then
    if [ -z "$NUM_BIGIPS" ]; then
        NUM_BIGIPS=$SCALEN_DEFAULT_SIZE
    fi
else
    show_usage
    echo "Invalid HA type!"
    exit 1
fi


if [ -z "KEYSTONE_ADDRESS" -o \
     -z "ADMIN_PASSWORD" -o \
     -z "HA_TYPE" -o \
     -z "BIGIP_IMAGE" -o \
     -z "NUM_BIGIPS" -o \
     -z "ICONTROL_IPS" -o \
     -z "MGMT_IPS" -o \
     -z "HA_IPS" -o \
     -z "MIRROR_IPS" ]; then
    show_usage
    exit 1
fi

set -x
stdbuf -o 0 -e 0 \
  python $F5_ONBOARD_BIGIP_PY_DIR/cluster_generic.py $KEYSTONE_ADDRESS \
                       --admin-password $ADMIN_PASSWORD \
                       --bigip-images $BIGIP_IMAGE \
                       --ha-type $HA_TYPE \
                       --num-bigips $NUM_BIGIPS
                       --bigip-floating-ip-addr-list $ICONTROL_IPS \
                       --bigip-mgmt-addr-list $MGMT_IPS \
                       --bigip-ha-addr-list $HA_IPS \
                       --bigip-mirror-addr-list $MIRROR_IPS 

set +x
if [ "$HA_TYPE" != "standalone" ]; then
    echo "Sleeping 60 seconds until BIG-IPs are clustered"
    sleep 60
fi


