source odk-utils

function show_usage {
    echo "Usage:"
    echo "f5-onboard-odk-test-loop"
    echo "  --lbaas-only    Loop on lbaas create and delete only"
}


LBAAS_ONLY=false
# Parse command line switches
while [ $# -gt 0 ]; do
   case "$1" in
       --lbaas-only)  LBAAS_ONLY=true; shift 1 ;;
       -h|help|--help) show_usage; exit 0;;
       *)              show_usage; exit 1;;
   esac
done

# If we are only creating and deleting lbaas objects in the loop
# then we need to initially setup the base objects by running
# the test without the --lbaas-only flag.
if [ "$LBAAS_ONLY" = true ]; then
    ext=`date +%m%d%y.%H%M`
    odk_qg mv /var/log/neutron/f5-bigip-lbaas-agent.log /var/log/neutron/f5-bigip-lbaas-agent.log.$ext
    odk_qg service f5-bigip-lbaas-agent restart
    sleep 2
    odk-openstack test --no-cleanup
    test_result=$?
    if [ $test_result != 0 ]; then
        echo $0: ERROR: Unable to complete initial setup test.
        exit 1
    fi
    LBAAS_ONLY_FLAG=--lbaas-only
fi
count=0
while true
do
    ext=`date +%m%d%y.%H%M`
    #odk_qg mv /var/log/neutron/f5-bigip-lbaas-agent.log /var/log/neutron/f5-bigip-lbaas-agent.log.$ext
    #odk_qg service f5-bigip-lbaas-agent restart
    sleep 2
    start_time=`date +%s`
    odk-openstack test $LBAAS_ONLY_FLAG
    test_result=$?
    finish_time=`date +%s`
    count=$((count + 1))
    echo "Test finished after $((finish_time - start_time)) seconds."
    echo "$count test iterations have been completed."
    if [ $test_result != 0 ]; then
        exit 1
    fi
    juju scp quantum-gateway/0:/var/log/neutron/f5-bigip-lbaas-agent.log .
    cat f5-bigip-lbaas-agent.log | grep -e ERROR
    grep_result=$?
    if [ $grep_result == 0 ]; then
        exit 1
    fi
    echo Waiting 10 seconds before running test again...
    sleep 10
done
