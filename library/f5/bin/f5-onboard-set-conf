#!/bin/bash

F5_ONBOARD_CONF_VARS_DIR="$HOME/.f5-onboard/conf/vars"

if [ $# -lt 3 ]; then
    echo "usage: f5-onboard-set-conf <collection> <entity> <variable-name>=<value>"
    echo "variables are name-value pairs that belong to an entity"
    echo "that is part of a collection"
    echo "Examples:"
    echo "$ f5-onboard-set-conf singletons globals dev_mode=True"
    exit 1
fi

# 
# Name value pairs (NAME=VALUE) are stored in a file with this name:
# $F5_ONBOARD_CONF_VARS_DIR/$COLLECTION/$ENTITY
# 

COLLECTION=$1
ENTITY=$2
NAME_VALUE=$3

VARIABLE_NAME=`echo $NAME_VALUE | cut -d= -f1`
VARIABLE_VALUE=`echo $NAME_VALUE | cut -d= -f2-`
echo "got $VARIABLE_NAME=$VARIABLE_VALUE"
ENTITY_DATAFILE="$F5_ONBOARD_CONF_VARS_DIR/$COLLECTION/$ENTITY"

mkdir -p $F5_ONBOARD_CONF_VARS_DIR/$COLLECTION
touch $ENTITY_DATAFILE
set +e
grep -q -e "^$VARIABLE_NAME=" $ENTITY_DATAFILE
retval=$?
set -e
if [ $retval = 0 ]; then
    sed -i "s/^$VARIABLE_NAME=.*/$VARIABLE_NAME=$VARIABLE_VALUE/" $ENTITY_DATAFILE
else
    echo "$VARIABLE_NAME=$VARIABLE_VALUE" >> $ENTITY_DATAFILE
fi
