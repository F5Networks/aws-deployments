---
# Dynamically populate groups from persisted results from previous playbooks.
- hosts:
   localhost
  gather_facts: no
  tasks:

    - shell: "cat ~/vars/f5aws/env/{{ env_name }}/{{ item }}.json"
      register: output
      with_items: groups['clienthost-managers']
      delegate_to: localhost

    - add_host: group=clienthosts
        name="{{ item.stdout | from_json | attr('get')('ClientInstancePublicIp') }}" group=clienthosts
        ClientInstancePublicIp="{{ item.stdout | from_json | attr('get')('ClientInstancePublicIp') }}"
        ClientInstancePrivateIp="{{ item.stdout | from_json | attr('get')('ClientInstancePrivateIp') }}"
        ansible_ssh_user="ubuntu"
      with_items: output['results']

# Kill Jmeter test clients
- hosts: clienthosts
  gather_facts: False
  tasks:

    - name: Kill Jmeter 
      #shell: kill `ps -ef | egrep jmeter | egrep -v egrep | awk '{print $2}'`
      shell: killall java

   
